{"version":3,"sources":["util.js"],"names":["RoapUtil","ROAP_ANSWER","_ANSWER_","toLowerCase","shouldHandleMedia","meeting","offer","mediaProperties","peerConnection","signalingState","SDP","HAVE_LOCAL_OFFER","handleError","pc","PeerConnectionManager","rollBackLocalDescription","then","resolve","catch","err","LoggerProxy","logger","error","reject","findError","messageType","errorType","type","ROAP","RECEIVE_ROAP_MSG","SEND_ROAP_MSG","_ERROR_","_CONFLICT_","ensureMeeting","SEND_ROAP_MSG_SUCCESS","updatePeerConnection","session","offerSdp","OFFER","sdps","meetingId","id","remoteQualityLevel","res","roap","lastRoapOffer","setRemoteDescription","info","correlationId","ParameterError","setRemoteSessionDetails","ANSWER","seq","locusId","locusSelfId","locusInfo","self","mediaId"],"mappings":"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","file":"util.js","sourcesContent":["\nimport PeerConnectionManager from '../peer-connection-manager';\nimport {\n  _ANSWER_,\n  _ERROR_,\n  _CONFLICT_,\n  ROAP,\n  SDP\n} from '../constants';\nimport LoggerProxy from '../common/logs/logger-proxy';\nimport ParameterError from '../common/errors/parameter';\n\nconst RoapUtil = {};\nconst ROAP_ANSWER = _ANSWER_.toLowerCase();\n\nRoapUtil.shouldHandleMedia = (meeting) => {\n  const offer =\n    meeting.mediaProperties.peerConnection &&\n    meeting.mediaProperties.peerConnection.signalingState === SDP.HAVE_LOCAL_OFFER;\n\n  if (offer) {\n    return false;\n  }\n\n  return true;\n};\n\nRoapUtil.handleError = (pc) =>\n  PeerConnectionManager.rollBackLocalDescription({peerConnection: pc})\n    .then(() => Promise.resolve(true))\n    .catch((err) => {\n      LoggerProxy.logger.error(`Roap:util#handleError --> ${err}`);\n\n      return Promise.reject(err);\n    });\n\nRoapUtil.findError = (messageType, errorType, type) =>\n  (type === ROAP.RECEIVE_ROAP_MSG || type === ROAP.SEND_ROAP_MSG) && messageType === _ERROR_ && errorType === _CONFLICT_;\n\nRoapUtil.ensureMeeting = (meeting, type) => {\n  if (type === ROAP.RECEIVE_ROAP_MSG || type === ROAP.SEND_ROAP_MSG || type === ROAP.SEND_ROAP_MSG_SUCCESS) {\n    if (!meeting) {\n      return false;\n    }\n  }\n\n  return true;\n};\n\nRoapUtil.updatePeerConnection = (meeting, session) => PeerConnectionManager.updatePeerConnection({\n  offerSdp: session.OFFER.sdps,\n  peerConnection: meeting.mediaProperties.peerConnection\n},\n{\n  meetingId: meeting.id,\n  remoteQualityLevel: meeting.mediaProperties.remoteQualityLevel\n})\n  .then((res) => {\n    meeting.roap.lastRoapOffer = session.OFFER.sdps;\n\n    return res;\n  });\n\n\nRoapUtil.setRemoteDescription = (meeting, session) => {\n  LoggerProxy.logger.info(`Roap:util#setRemoteDescription --> Transmit WAIT_TX_OK, correlationId: ${meeting.correlationId}`);\n  if (!(meeting && (meeting.mediaProperties.peerConnection))) {\n    LoggerProxy.logger.error(`Roap:util#setRemoteDescription --> DANGER no media or screen peer connection, correlationId: ${meeting.correlationId}`);\n\n    return Promise.reject(new ParameterError('Must provide a media or screen peer connection'));\n  }\n\n  return PeerConnectionManager.setRemoteSessionDetails(\n    meeting.mediaProperties.peerConnection,\n    ROAP_ANSWER,\n    session.ANSWER.sdps[0],\n    meeting.id\n  ).then(() => {\n    LoggerProxy.logger.info(`Roap:util#setRemoteDescription --> Success for correlationId: ${meeting.correlationId}`);\n\n    return {\n      seq: session.ANSWER.seq,\n      locusId: meeting.locusId,\n      locusSelfId: meeting.locusInfo.self.id,\n      mediaId: meeting.mediaId,\n      correlationId: meeting.correlationId\n    };\n  })\n    .catch((err) => {\n      LoggerProxy.logger.error(`Roap:util#setRemoteDescription --> ${err}`);\n      throw err;\n    });\n};\n\nexport default RoapUtil;\n"]}